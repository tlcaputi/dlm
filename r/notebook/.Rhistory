stop("The exposure data is still not balanced after taking unique values of unit, time, and exposure.")
}
}
# Capture time bounds
MINTIME = min(exposure_data[[time]], na.rm = TRUE)
MAXTIME = max(exposure_data[[time]], na.rm = TRUE)
log_info("MINTIME: {MINTIME}")
log_info("MAXTIME: {MAXTIME}")
data_years_included = (MINTIME + abs(to_rt)):(MAXTIME - abs(from_rt) + 1)
log_info("Data years that could be included, based upon the exposure data")
print(data_years_included)
data_years_included = intersect(data_years_included, unique(data[[time]]))
log_info("Data years that actually are included, based upon the exposure and outcome data")
print(data_years_included)
# Create leads and lags
log_info("Creating leads and lags")
leads = character(0)
if (abs(from_rt) > 1) {
for (i in (abs(from_rt) - 1):1) {
exposure_data = exposure_data %>%
group_by(!!sym(unit)) %>%
mutate("{exposure}_lead{i}" := dplyr::lead(!!sym(exposure), i))
leads = c(leads, glue("{exposure}_lead{i}"))
}
}
leads_str = paste0(leads, collapse = " + ")
lags = character(0)
for (i in 0:to_rt) {
exposure_data = exposure_data %>%
group_by(!!sym(unit)) %>%
mutate("{exposure}_lag{i}" := dplyr::lag(!!sym(exposure), i))
lags = c(lags, glue("{exposure}_lag{i}"))
}
lags_str = paste0(lags, collapse = " + ")
log_info("Done creating leads and lags")
# Merge data
tmp = merge(data, exposure_data, by = c(unit, time), all.x = TRUE)
tmp = tmp %>% mutate(unit := !!sym(unit), time := !!sym(time))
# Loop over outcomes
.list = lapply(outcomes, function(outcome) {
run_model = function() {
log_info("Processing {outcome}")
# Build formula
fes = if (remove_unit_FE) c("time", addl_fes) else c("unit", "time", addl_fes)
fe_str = paste0(fes, collapse = " + ")
if (!is.null(covariates)) {
covariate_str = paste0(covariates, collapse = " + ")
fmla_str = glue("{outcome} ~ {leads_str} + {covariate_str} | {fe_str}")
} else {
fmla_str = glue("{outcome} ~ {leads_str} | {fe_str}")
}
log_info("Formula:")
print(fmla_str)
# Estimate model
args = c("data = tmp", "cluster = ~unit", "fixef.rm = 'none'", addl_arguments)
if (!is.null(weights)) args = c(args, glue("weights = ~{weights}"))
cmd = glue("fixest::{model_type}({fmla_str}, {paste0(args, collapse = ', ')})")
model = eval(parse(text = cmd))
# Extract coefficients
num_vars = abs(from_rt) + to_rt
gamma = model$coefficients[1:num_vars]
vcov_mat = vcov(model, cluster = ~unit)[1:num_vars, 1:num_vars]
# Sum to reference
if (from_rt == ref_period) {
after_periods = 1:num_vars
coefs = cumsum(gamma[after_periods])
ses = secumsum(as.matrix(vcov_mat)[after_periods, after_periods])
time_to_event = sort(setdiff(from_rt:to_rt, ref_period))
} else {
time_to_event = sort(setdiff(from_rt:to_rt, ref_period))
num_before = length(time_to_event[time_to_event < ref_period])
before = 1:num_before
after = (num_before + 1):num_vars
coefs = c(-revcumsum(gamma[before]), cumsum(gamma[after]))
ses = c(serevcumsum(vcov_mat[before, before]), secumsum(vcov_mat[after, after]))
}
betas = data.frame(time_to_event = time_to_event, coef = coefs, se = ses)
# Apply dict labels if provided
outcome_name = "Coefficient"
exposure_name = "Time to Unit Change"
if (!is.null(dict)) {
if (outcome %in% names(dict)) outcome_name = dict[outcome]
if (exposure %in% names(dict)) exposure_name = glue("Time to Unit Change in {dict[exposure]}")
}
# Build plot
plotdf = rbind(betas, data.frame(time_to_event = ref_period, coef = 0, se = 0)) %>%
mutate(time_to_event_str = case_when(
time_to_event == from_rt ~ glue("{from_rt}+"),
time_to_event == to_rt   ~ glue("{to_rt}+"),
TRUE                     ~ as.character(time_to_event)
)) %>%
arrange(time_to_event)
p = ggplot(plotdf, aes(x = time_to_event, y = coef)) +
geom_line() + geom_point() +
geom_errorbar(aes(ymin = coef - 1.96*se, ymax = coef + 1.96*se), width = 0.2) +
geom_hline(yintercept = 0, linetype = "dashed") +
geom_vline(xintercept = ref_period + 0.5, linetype = "dashed") +
labs(
x = exposure_name,
y = outcome_name,
caption = glue("N={comma(nobs(model))} | From {min(data_years_included)} To {max(data_years_included)} | {Sys.time()}")
) +
theme_bw()
# Add DD caption if requested
if (dd) {
out = twfe_companion(
data = data,
exposure_data = exposure_data,
from_rt = from_rt,
to_rt = to_rt,
outcome = outcome,
exposure = exposure,
unit = unit,
time = time,
covariates = covariates,
addl_fes = addl_fes,
ref_period = ref_period,
weights = weights,
dd = dd,
n = n
)
p = add_caption_to_plot(p, out)
}
list(
betas                = betas,
plot                 = p,
model                = model,
vcov                 = vcov_mat,
data_years_included  = data_years_included,
fmla_str             = fmla_str,
from_rt              = from_rt,
to_rt                = to_rt,
cmd                  = cmd,
exposure             = exposure,
outcome              = outcome
)
}
if (try_catch) {
result = tryCatch(
run_model(),
error = function(e) {
log_info("Error in outcome {outcome}")
log_info("Returning NULL for this outcome")
print(e)
NULL
}
)
} else {
result = run_model()
}
result
})
# Filter out NULLs and return
.list = .list[!sapply(.list, is.null)]
if (length(.list) == 0) {
log_error("No outcomes were estimated")
return(NULL)
} else if (length(.list) == 1) {
return(.list[[1]])
} else {
return(.list)
}
}
# Distributed Lags Model
mod = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
# TWFE model for comparison
comp = standard_twfe_for_comparison(
data = raw,
from_rt = -3,
to_rt = 3,
outcome = "outcome",
unit = "group",
time = "time",
time_to_treatment = "years_to_treatment",
treat = "treat"
)
# Should be the same
print(mod$betas)
print(comp$betas)
# Load package
rm(distributed_lags_models)
devtools::install_github("tlcaputi/dlm")
library(dlm)
library(dplyr)
# Generate Data
raw = generate_data()
raw = raw %>% mutate(outcome2 = outcome - 1 + rnorm(nrow(raw), 0, 1))
# Separate data
data = raw %>% select(-post)
exposure_data = raw %>% select(group, time, post) %>% unique()
# Distributed Lags Model
mod = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
# TWFE model for comparison
comp = standard_twfe_for_comparison(
data = raw,
from_rt = -3,
to_rt = 3,
outcome = "outcome",
unit = "group",
time = "time",
time_to_treatment = "years_to_treatment",
treat = "treat"
)
# Should be the same
print(mod$betas)
print(comp$betas)
# roxygen2::roxygenise()
# Load package
# rm(distributed_lags_models)
# devtools::install_github("tlcaputi/dlm")
devtools::install_github("tlcaputi/dlm@backup-master-before-rewind", force = TRUE)
library(dlm)
library(dplyr)
# devtools::load_all(".")
# Generate Data
raw = generate_data()
raw = raw %>% mutate(outcome2 = outcome - 1 + rnorm(nrow(raw), 0, 1))
# Separate data
data = raw %>% select(-post)
exposure_data = raw %>% select(group, time, post) %>% unique()
# Distributed Lags Model
mod = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
mod = mod[[1]]
# mod$plot
# str(mod)
# TWFE model for comparison
comp = standard_twfe_for_comparison(
data = raw,
from_rt = -3,
to_rt = 3,
outcome = "outcome",
unit = "group",
time = "time",
time_to_treatment = "years_to_treatment",
treat = "treat"
)
# Should be the same
print(mod$betas)
print(comp$betas)
# Distributed Lags Model
mod = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
mod$betas
mod$betas
# TWFE model for comparison
comp = standard_twfe_for_comparison(
data = raw,
from_rt = -3,
to_rt = 3,
outcome = "outcome",
unit = "group",
time = "time",
time_to_treatment = "years_to_treatment",
treat = "treat"
)
# Should be the same
print(mod$betas)
print(comp$betas)
help(generate_data)
# Load package
# rm(distributed_lags_models)
# devtools::install_github("tlcaputi/dlm")
devtools::install_github("tlcaputi/dlm@backup-master-before-rewind", force = TRUE)
library(dlm)
library(dplyr)
# Generate Data
raw = generate_data()
raw = generate_data(seed = 12345, n_groups = 40^2, n_times = 400, treat_prob = 0.1)
raw = raw %>% mutate(outcome2 = outcome - 1 + rnorm(nrow(raw), 0, 1))
# Separate data
data = raw %>% select(-post)
exposure_data = raw %>% select(group, time, post) %>% unique()
# Distributed Lags Model
mod = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
mod$betas
# TWFE model for comparison
comp = standard_twfe_for_comparison(
data = raw,
from_rt = -3,
to_rt = 3,
outcome = "outcome",
unit = "group",
time = "time",
time_to_treatment = "years_to_treatment",
treat = "treat"
)
# Should be the same
print(mod$betas)
print(comp$betas)
# Should be the same
print(mod$betas$coef)
all(abs(mod$betas$coef - comp$betas$coef) < 0.0001)
# roxygen2::roxygenise()
# Load package
# rm(distributed_lags_models)
# devtools::install_github("tlcaputi/dlm")
devtools::install_github("tlcaputi/dlm@backup-master-before-rewind", force = TRUE)
library(dlm)
library(dplyr)
# devtools::load_all(".")
# Generate Data
raw = generate_data()
raw = generate_data(seed = 12345, n_groups = 40^2, n_times = 400, treat_prob = 0.1)
raw = raw %>% mutate(outcome2 = outcome - 1 + rnorm(nrow(raw), 0, 1))
# Separate data
data = raw %>% select(-post)
exposure_data = raw %>% select(group, time, post) %>% unique()
# Distributed Lags Model
mod = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
mod$betas
# mod$plot
# str(mod)
# TWFE model for comparison
comp = standard_twfe_for_comparison(
data = raw,
from_rt = -3,
to_rt = 3,
outcome = "outcome",
unit = "group",
time = "time",
time_to_treatment = "years_to_treatment",
treat = "treat"
)
# Should be the same
print(mod$betas)
print(comp$betas)
all(abs(mod$betas$coef - comp$betas$coef) < 0.0001)
mod$plot
# roxygen2::roxygenise()
# Load package
# rm(distributed_lags_models)
# devtools::install_github("tlcaputi/dlm")
# devtools::install_github("tlcaputi/dlm@backup-master-before-rewind", force = TRUE)
devtools::install_github("tlcaputi/dlm", force = TRUE)
library(dlm)
library(dplyr)
# devtools::load_all(".")
# Generate Data
raw = generate_data()
raw = generate_data(seed = 12345, n_groups = 40^2, n_times = 400, treat_prob = 0.1)
raw = raw %>% mutate(outcome2 = outcome - 1 + rnorm(nrow(raw), 0, 1))
# Separate data
data = raw %>% select(-post)
exposure_data = raw %>% select(group, time, post) %>% unique()
# Distributed Lags Model
mods1 = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
mods2 = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = "outcome",
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
mods1[[1]]$betas
mods2[[1]]$betas
length(mods1)
mods1$betas
mods2$betas
# roxygen2::roxygenise()
# Load package
# rm(distributed_lags_models)
# devtools::install_github("tlcaputi/dlm")
# devtools::install_github("tlcaputi/dlm@backup-master-before-rewind", force = TRUE)
devtools::install_github("tlcaputi/dlm", force = TRUE)
library(dlm)
library(dplyr)
# devtools::load_all(".")
# Generate Data
raw = generate_data()
raw = generate_data(seed = 12345, n_groups = 40^2, n_times = 400, treat_prob = 0.1)
raw = raw %>% mutate(outcome2 = outcome - 1 + rnorm(nrow(raw), 0, 1))
# Separate data
data = raw %>% select(-post)
exposure_data = raw %>% select(group, time, post) %>% unique()
outcomes = c("outcome", "outcome2")
# Distributed Lags Model
mods1 = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = outcomes,
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
mods2 = distributed_lags_models(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = outcomes,
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
length(mods1)
mods1[[1]]$betas
mods2[[1]]$betas
mods1[[2]]$betas
mods2[[2]]$betas
mods2 = distributed_lags_models2(
data = data,
exposure_data = exposure_data,
from_rt = -3,
to_rt = 3,
remove_unit_FE = F,
outcome = outcomes,
exposure = "post",
unit = "group",
time = "time",
dd = T,
n = 4
)
# Load package
rm(distributed_lags_models)
rm(list = ls())
