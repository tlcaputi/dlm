# dlm Package — Current State

Last updated: 2026-02-08 18:20 ET

## Overview

The `dlm` package implements distributed lag models (Schmidheiny & Siegloch 2023, JAE) in both R and Stata. It is fully functional, tested, documented, and deployed.

## Repositories

| Repo | URL | Branch |
|------|-----|--------|
| R package + docs source | `github.com/tlcaputi/dlm` | `main` |
| Stata package | `github.com/tlcaputi/dlm-stata` | `main` |
| Docs deployment | `github.com/tlcaputi/dlm` | `gh-pages` |
| Personal website | `github.com/tlcaputi/tlcaputi.github.io` | `master` |

## Local File Locations

| What | Path |
|------|------|
| Package source (R + Stata + docs) | `/Users/theo/DropboxMIT/packages/dlm/` |
| R package code | `/Users/theo/DropboxMIT/packages/dlm/r/` |
| Stata package code | `/Users/theo/DropboxMIT/packages/dlm/stata/` |
| MkDocs source | `/Users/theo/DropboxMIT/packages/dlm/docs/` + `mkdocs.yml` |
| Deploy working copy | `/tmp/dlm-docs-deploy/` (clone of tlcaputi/dlm, main branch) |
| Personal website source | `/Users/theo/MIT Dropbox/Theodore Caputi/job-market/gh-website/` |

**Important:** `/tmp/dlm-docs-deploy/` is ephemeral. If it doesn't exist, re-clone:
```bash
cd /tmp && git clone https://github.com/tlcaputi/dlm.git dlm-docs-deploy
```

## Build and Deploy Commands

```bash
# Build docs
cd /tmp/dlm-docs-deploy
~/.pyenv/versions/antipsychotics/bin/mkdocs build --strict

# Deploy to gh-pages
~/.pyenv/versions/antipsychotics/bin/ghp-import -n -p -f site

# After editing source files in /Users/theo/DropboxMIT/packages/dlm/:
# 1. Copy changed files to /tmp/dlm-docs-deploy/
# 2. Build
# 3. git add/commit/push (main branch)
# 4. ghp-import (gh-pages branch)
```

## What's Working

### R Package (`devtools::install_github("tlcaputi/dlm")`)
- `distributed_lags_model()` — single-outcome DLM estimation
- `distributed_lags_models()` — multi-outcome batch estimation
- `generate_data()` — test data generator
- `standard_twfe_for_comparison()` — canonical binned-endpoint event study
- Built-in event-study plot via `mod$plot` (ggplot2 object)
- All tests passing (28/28 doc examples + worked example + equivalence test)

### Stata Package (`net install dlm, from(...)`)
- `dlm` command — single-outcome DLM estimation
- `dlm_gen_data` — test data generator
- Returns `e(betas)` matrix with coefficients, SEs, CIs
- All tests passing (18/18 doc examples + worked example + equivalence test)
- Requires `reghdfe` (`ssc install reghdfe`)

### Documentation Site (theodorecaputi.com/dlm/)
- MkDocs Material theme with dark/light mode
- Pages: Home, Installation, Quick Start, Worked Example, R Guide, R API, Stata Guide, Stata API, Theory
- Custom SVG logo, headshot, 10 event-study plot images
- R shown before Stata everywhere (R is the "default" language)
- MkDocs footer hidden via custom CSS
- **Every output shown is reproducible** by running the exact code displayed

### Personal Website (theodorecaputi.com/#software)
- Single `dlm` card with R + Stata badges
- Separate GitHub links and install commands for each language
- Documentation link to shared docs site

## Key Design Decisions

1. **aggr_es() removed from docs** — It's a fixest utility bundled in the R package as a dependency of `ggiplot`/`iplot_data`, but it doesn't work with DLM model objects. Only works with fixest models estimated via `i()`.

2. **Attribution** — The citation section explicitly states these packages are by Theodore Caputi, implement S&S's method, borrow from their replication code, and are not affiliated with the original authors.

3. **Equivalence verification** — Both R and Stata implementations produce coefficients matching a canonical binned-endpoint event study to machine precision (~1e-15 in R, ~1e-13 in Stata).

4. **No plotting in Stata** — Users construct plots manually from `e(betas)` matrix. The quickstart, worked example, and Stata guide all show how with actual plot images.

5. **No fake results** — Every output block in every doc page was generated by running the exact code shown. All outputs verified 2026-02-08.

6. **RNG difference documented** — R and Stata use different RNGs, so `seed(42)` produces different data. Each language shows its own correct output. A note explains this on the quickstart and worked example pages.

## Known Issues / Limitations

- The R package exports some functions that are really fixest utilities (`aggr_es`, `ggiplot`, `iplot_data`). These are used internally but could confuse users. They've been removed from docs but are still exported in the NAMESPACE.
- `standard_twfe_for_comparison()` requires `library(ggplot2)` to be loaded (it calls `ggiplot` internally which uses ggplot2 functions).
- Stata `dlm_gen_data` uses a different RNG than R's `generate_data()`, so the same seed produces different data. Cross-language equivalence is verified within each language, not across.

## Documentation Output Verification

All output was verified by running:

```bash
# R — all quickstart, guide, and worked example output
Rscript -e '...exact code from docs...'

# Stata — all quickstart, guide, and worked example output
# Write .do file, then:
/Applications/Stata/StataSE.app/Contents/MacOS/stata-se -b do /tmp/verify.do
```

### R output parameters
- `generate_data(seed = 42, n_groups = 500, n_times = 20, treat_prob = 0.4)`
- `distributed_lags_model(from_rt = -3, to_rt = 3, outcome = "outcome", exposure = "post", unit = "group", time = "time")`
- R betas: −0.118, −0.063, −2.641, −2.260, −3.042, −2.618

### Stata output parameters
- `dlm_gen_data, n_groups(500) n_times(20) treat_prob(0.4) seed(42) clear`
- `dlm outcome, exposure(post) unit(unit) time(time) from(-3) to(3)`
- Stata betas: −0.064, 0.095, −2.764, −3.094, −2.708, −3.257

## File Map

```
dlm/
├── r/                          # R package
│   ├── R/
│   │   ├── dlm-functions.R     # Core: distributed_lags_model(), generate_data(), etc.
│   │   ├── utils.R             # Helpers: revcumsum(), secumsum(), etc.
│   │   ├── aggr_es.R           # fixest utility (NOT dlm-specific)
│   │   ├── iplot_data.R        # fixest utility (NOT dlm-specific)
│   │   ├── cpi-functions.R     # CPI/inflation adjustment utilities
│   │   └── data.R              # Data documentation
│   ├── man/                    # Rd help files
│   ├── DESCRIPTION
│   └── NAMESPACE
├── stata/                      # Stata package
│   ├── dlm.ado                 # Main estimation command (includes Mata)
│   ├── dlm_gen_data.ado        # Test data generator
│   ├── dlm.sthlp               # Help file
│   ├── stata.toc               # Package index
│   ├── dlm.pkg                 # Package descriptor
│   ├── test_dlm_equivalence.do # Equivalence test
│   └── test_cross_language.do  # Cross-language comparison
├── docs/                       # MkDocs source
│   ├── index.md                # Homepage
│   ├── getting-started/
│   │   ├── installation.md
│   │   ├── quickstart.md       # Full output for both R and Stata + plots
│   │   └── worked-example.md   # Full worked example with 3 comparison plots
│   ├── r/
│   │   ├── guide.md            # Usage guide with output + 2 plot images
│   │   └── api.md
│   ├── stata/
│   │   ├── guide.md            # Usage guide with output + plot image
│   │   └── api.md
│   ├── theory/
│   │   └── background.md       # Intuitive explanation + formal math
│   ├── assets/
│   │   ├── logo.svg            # DLM logo
│   │   ├── headshot.jpg        # Developer photo
│   │   ├── plot_event_study.png      # Worked example: ES plot
│   │   ├── plot_dlm.png              # Worked example: DLM plot
│   │   ├── plot_combined.png         # Worked example: overlay plot
│   │   ├── plot_quickstart_r.png     # Quickstart: R mod$plot
│   │   ├── plot_quickstart_stata.png # Quickstart: Stata twoway
│   │   ├── plot_r_guide_default.png  # R guide: default mod$plot
│   │   ├── plot_r_guide_custom.png   # R guide: customized plot
│   │   └── plot_stata_guide.png      # Stata guide: twoway plot
│   └── stylesheets/
│       └── extra.css           # Hides MkDocs footer
├── mkdocs.yml                  # MkDocs config
└── .CHANGELOG/                 # Session changelogs
```

## Test Commands

```bash
# R tests
Rscript /Users/theo/DropboxMIT/packages/dlm/r/test_docs_examples.R
Rscript /Users/theo/DropboxMIT/packages/dlm/r/test_worked_example.R

# Stata tests (requires Stata)
/Applications/Stata/StataSE.app/Contents/MacOS/stata-se -b do /Users/theo/DropboxMIT/packages/dlm/stata/test_dlm_equivalence.do
/Applications/Stata/StataSE.app/Contents/MacOS/stata-se -b do /Users/theo/DropboxMIT/packages/dlm/stata/test_worked_example.do

# MkDocs strict build
cd /tmp/dlm-docs-deploy && ~/.pyenv/versions/antipsychotics/bin/mkdocs build --strict
```

## Changelogs

| Date | File | Summary |
|------|------|---------|
| 2026-02-08 16:27 | `2026-02-08_162738_docs-plots-attribution-website.md` | Initial docs: plots, attribution, GitHub links, headshot, website update |
| 2026-02-08 18:20 | `2026-02-08_182038_docs-output-consistency-plots.md` | Output consistency: fixed fake values, wrong Stata output, broken code, added R+Stata output and plots to all pages |
